---
import "../styles/global.css";
import { tools } from "../config/tools";

interface Props {
  title: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  keywords?: string;
}

const {
  title,
  description = "Tools Hub provides fast, browser-based tools for developers, creators, and daily workflows.",
  image = "/og-image.svg",
  noindex = false,
  keywords = "Tools Hub, Developer Tools, Online Generators, Web Tools, Frontend Utilities, Password Generator, JSON Converter, Corey Burns",
} = Astro.props;

const siteName = "Tools Hub";
const siteUrl = Astro.site?.toString() ?? "https://tools.coreyburns.ca";
const pageTitle = `${title} | ${siteName}`;
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();
const socialImageUrl =
  image.startsWith("https://") || image.startsWith("http://")
    ? image
    : new URL(image, siteUrl).toString();
const robotsContent = noindex ? "noindex, nofollow" : "index, follow";
const structuredData = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: siteName,
  applicationCategory: "DeveloperApplication",
  operatingSystem: "Web",
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "USD",
  },
  description,
  url: canonicalUrl,
  author: {
    "@type": "Person",
    name: "Corey Burns",
    url: "https://coreyburns.ca",
  },
  isPartOf: {
    "@type": "WebSite",
    name: siteName,
    url: siteUrl,
  },
});

const categoryLabels: Record<string, string> = {
  dev: "Developer",
  general: "General",
  fun: "Fun & Games",
  productivity: "Productivity",
};

const grouped = tools.reduce(
  (acc, tool) => {
    const cat = tool.category;
    if (!acc[cat]) acc[cat] = [];
    acc[cat].push(tool);
    return acc;
  },
  {} as Record<string, typeof tools>
);

const categoryOrder = ["dev", "general", "fun", "productivity"];
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <title>{pageTitle}</title>
    <meta name="description" content={description} />
    <meta name="author" content="Corey Burns" />
    <meta name="keywords" content={keywords} />
    <meta name="robots" content={robotsContent} />
    <meta name="theme-color" content="#080b16" />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={socialImageUrl} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageUrl} />
    <script is:inline type="application/ld+json" set:html={structuredData} />
  </head>
  <body class="relative min-h-screen">
    <div class="layout-wrapper">
      <!-- Sidebar -->
      <aside
        class="sidebar"
        id="sidebar-menu"
      >
        <div class="flex h-full flex-col">
          <!-- Brand -->
          <a href="/" class="brand-link group">
            <div class="brand-icon">
              <svg class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="font-outfit text-lg font-bold tracking-tight text-white">Tools Hub</span>
              <span class="text-[10px] font-medium tracking-widest text-slate-500 uppercase">by Corey Burns</span>
            </div>
          </a>

          <!-- Navigation -->
          <nav class="sidebar-nav">
            {
              categoryOrder.map((catKey) => {
                const catTools = grouped[catKey];
                if (!catTools) return null;
                return (
                  <div class="nav-group">
                    <div class="nav-group-label">
                      {categoryLabels[catKey] || catKey}
                    </div>
                    {catTools.map((tool) => (
                      <a
                        href={tool.path}
                        class:list={[
                          "nav-link",
                          { active: tool.path === Astro.url.pathname },
                        ]}
                      >
                        <span class="nav-link-icon">{tool.icon}</span>
                        <span class="nav-link-text">{tool.name}</span>
                        {tool.path === Astro.url.pathname && (
                          <span class="nav-active-dot" />
                        )}
                      </a>
                    ))}
                  </div>
                );
              })
            }
          </nav>

          <!-- Sidebar Footer -->
          <div class="sidebar-footer">
            <div class="sidebar-footer-card">
              <span class="text-[11px] font-semibold text-slate-400">Tools Hub</span>
              <span class="text-[10px] text-slate-600">v2.1 &middot; Open Source</span>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content" id="main-content">
        <!-- Mobile Header -->
        <header class="mobile-header">
          <a href="/" class="flex items-center gap-2.5">
            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600/90">
              <svg class="h-4 w-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
              </svg>
            </div>
            <span class="font-outfit text-base font-bold text-white">Tools Hub</span>
          </a>
          <button
            id="mobile-menu-toggle"
            class="mobile-menu-btn"
            aria-label="Toggle Menu"
            aria-controls="sidebar-menu"
            aria-expanded="false"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </header>

        <div class="page-shell">
          <slot />
        </div>
      </main>
    </div>

    <!-- Overlay for mobile -->
    <div
      id="sidebar-overlay"
      class="sidebar-overlay"
    >
    </div>
  </body>
</html>

<style is:global>
  @layer base {
    * {
      box-sizing: border-box;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: "Outfit", system-ui, sans-serif;
    }

    html {
      scroll-behavior: smooth;
    }
  }

  /* ─── Layout Shell ─── */
  .layout-wrapper {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  /* ─── Sidebar ─── */
  .sidebar {
    position: fixed;
    inset-block: 0;
    left: 0;
    z-index: 50;
    width: 260px;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(10, 13, 28, 0.95);
    backdrop-filter: blur(20px) saturate(1.3);
    border-right: 1px solid rgba(255, 255, 255, 0.04);
  }

  @media (min-width: 768px) {
    .sidebar {
      position: relative;
      transform: translateX(0);
      flex-shrink: 0;
    }
  }

  .brand-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem 0.5rem;
    text-decoration: none !important;
  }

  .brand-icon {
    display: flex;
    height: 2.25rem;
    width: 2.25rem;
    align-items: center;
    justify-content: center;
    border-radius: 0.625rem;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .brand-link:hover .brand-icon {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35);
  }

  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 0.25rem 0.5rem 0.5rem;
  }

  .nav-group {
    margin-bottom: 0.25rem;
  }

  .nav-group-label {
    padding: 0.375rem 0.5rem 0.25rem;
    font-size: 0.625rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.2);
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.5rem;
    margin: 1px 0;
    border-radius: 0.625rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.45);
    text-decoration: none !important;
    transition: all 0.2s;
    position: relative;
  }

  .nav-link:hover {
    color: rgba(255, 255, 255, 0.85);
    background: rgba(255, 255, 255, 0.04);
  }

  .nav-link.active {
    color: #a5b4fc;
    background: rgba(99, 102, 241, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.12);
  }

  .nav-link-icon {
    font-size: 1rem;
    width: 1.5rem;
    text-align: center;
    flex-shrink: 0;
    transition: transform 0.2s;
  }

  .nav-link:hover .nav-link-icon {
    transform: scale(1.1);
  }

  .nav-link-text {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .nav-active-dot {
    width: 0.375rem;
    height: 0.375rem;
    border-radius: 50%;
    background: #818cf8;
    box-shadow: 0 0 8px rgba(129, 140, 248, 0.5);
    flex-shrink: 0;
  }

  .sidebar-footer {
    padding: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.03);
  }

  .sidebar-footer-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.125rem;
    padding: 0.5rem;
    border-radius: 0.625rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.03);
  }

  /* ─── Main Content ─── */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    min-width: 0;
  }

  .mobile-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    flex-shrink: 0;
    z-index: 10;
    background: rgba(8, 11, 22, 0.85);
    backdrop-filter: blur(12px) saturate(1.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  }

  @media (min-width: 768px) {
    .mobile-header {
      display: none;
    }
  }

  .mobile-header a {
    text-decoration: none !important;
  }

  .mobile-menu-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.375rem;
    border-radius: 0.375rem;
    color: rgba(255, 255, 255, 0.5);
    transition: all 0.2s;
    cursor: pointer;
    background: transparent;
    border: none;
  }

  .mobile-menu-btn:hover {
    color: white;
    background: rgba(255, 255, 255, 0.05);
  }

  .page-shell {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 82rem;
    margin-inline: auto;
    padding: 0.5rem 0.5rem;
    overflow: hidden;
    min-height: 0;
  }

  @media (min-width: 768px) {
    .page-shell {
      padding: 0.625rem 0.75rem;
    }
  }

  @media (min-width: 1024px) {
    .page-shell {
      padding: 0.75rem 1rem;
    }
  }

  /* ─── Sidebar Overlay (Mobile) ─── */
  .sidebar-overlay {
    position: fixed;
    inset: 0;
    z-index: 40;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  @media (min-width: 768px) {
    .sidebar-overlay {
      display: none;
    }
  }
</style>

<script>
  type ClientLogEntry = {
    id: string;
    level: "error";
    source: string;
    message: string;
    stack?: string | null;
    file?: string | null;
    line?: number | null;
    col?: number | null;
    path: string;
    ts: string;
  };

  const LOG_STORAGE_KEY = "toolsHub:clientLogs";
  const MAX_CLIENT_LOGS = 200;
  const LOGGER_FLAG_KEY = "__TOOLS_HUB_LOGGER_INSTALLED__";
  const loggerFlags = window as unknown as Record<string, boolean>;

  function toText(value: unknown): string {
    if (value instanceof Error) {
      return `${value.name}: ${value.message}\n${value.stack || ""}`.trim();
    }

    if (typeof value === "string") return value;

    try {
      return JSON.stringify(value);
    } catch {
      return String(value);
    }
  }

  function appendClientLog(entry: ClientLogEntry) {
    try {
      const existing = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]") as unknown;
      const next = Array.isArray(existing) ? existing : [];
      next.push(entry);

      if (next.length > MAX_CLIENT_LOGS) {
        next.splice(0, next.length - MAX_CLIENT_LOGS);
      }

      localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(next));
      window.dispatchEvent(new CustomEvent("tools-hub:log-added", { detail: entry }));
    } catch {
      // Ignore storage errors (quota/private mode) without breaking app flow.
    }
  }

  if (!loggerFlags[LOGGER_FLAG_KEY]) {
    loggerFlags[LOGGER_FLAG_KEY] = true;

    window.addEventListener("error", (event) => {
      appendClientLog({
        id: crypto.randomUUID(),
        level: "error",
        source: "window.error",
        message: event.message || "Unhandled error",
        stack: event.error?.stack || null,
        file: event.filename || null,
        line: event.lineno || null,
        col: event.colno || null,
        path: location.pathname,
        ts: new Date().toISOString(),
      });
    });

    window.addEventListener("unhandledrejection", (event) => {
      appendClientLog({
        id: crypto.randomUUID(),
        level: "error",
        source: "window.unhandledrejection",
        message: toText(event.reason || "Unhandled promise rejection"),
        stack: event.reason?.stack || null,
        path: location.pathname,
        ts: new Date().toISOString(),
      });
    });

    const originalConsoleError = console.error.bind(console);
    console.error = (...args: unknown[]) => {
      appendClientLog({
        id: crypto.randomUUID(),
        level: "error",
        source: "console.error",
        message: args.map(toText).join(" "),
        path: location.pathname,
        ts: new Date().toISOString(),
      });
      originalConsoleError(...args);
    };
  }

  // Sidebar Toggle Logic
  const toggle = document.getElementById("mobile-menu-toggle") as HTMLButtonElement | null;
  const sidebar = document.getElementById("sidebar-menu");
  const overlay = document.getElementById("sidebar-overlay");

  function closeMenu() {
    sidebar?.style.setProperty("transform", "translateX(-100%)");
    if (overlay) {
      overlay.style.opacity = "0";
      overlay.style.pointerEvents = "none";
    }
  }

  function openMenu() {
    sidebar?.style.setProperty("transform", "translateX(0)");
    if (overlay) {
      overlay.style.opacity = "1";
      overlay.style.pointerEvents = "auto";
    }
  }

  if (toggle) {
    toggle.addEventListener("click", () => {
      const isHidden = sidebar?.style.transform === "translateX(-100%)" ||
        getComputedStyle(sidebar!).transform.includes("-");
      if (isHidden) openMenu();
      else closeMenu();
    });
  }

  overlay?.addEventListener("click", closeMenu);

  // Close menu on navigation
  document.querySelectorAll("nav a").forEach((link) => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 768) {
        closeMenu();
      }
    });
  });
</script>
