---
import "../styles/global.css";
import { tools } from "../config/tools";

interface Props {
  title: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  keywords?: string;
}

const {
  title,
  description = "Tools Hub provides fast, browser-based tools for developers, creators, and daily workflows.",
  image = "/og-image.svg",
  noindex = false,
  keywords = "Tools Hub, Developer Tools, Online Generators, Web Tools, Frontend Utilities, Password Generator, JSON Converter, Corey Burns",
} = Astro.props;

const siteName = "Tools Hub";
const siteUrl = Astro.site?.toString() ?? "https://tools.coreyburns.ca";
const pageTitle = `${title} | ${siteName}`;
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();
const socialImageUrl =
  image.startsWith("https://") || image.startsWith("http://")
    ? image
    : new URL(image, siteUrl).toString();
const robotsContent = noindex ? "noindex, nofollow" : "index, follow";
const structuredData = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: siteName,
  applicationCategory: "DeveloperApplication",
  operatingSystem: "Web",
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "USD",
  },
  description,
  url: canonicalUrl,
  author: {
    "@type": "Person",
    name: "Corey Burns",
    url: "https://coreyburns.ca",
  },
  isPartOf: {
    "@type": "WebSite",
    name: siteName,
    url: siteUrl,
  },
});
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@500;700;800&display=swap"
      rel="stylesheet"
    />
    <title>{pageTitle}</title>
    <meta name="description" content={description} />
    <meta name="author" content="Corey Burns" />
    <meta name="keywords" content={keywords} />
    <meta name="robots" content={robotsContent} />
    <meta name="theme-color" content="#020617" />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={socialImageUrl} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageUrl} />
    <script is:inline type="application/ld+json" set:html={structuredData} />
  </head>
  <body class="relative min-h-screen bg-slate-950 text-slate-100 selection:bg-blue-500/30">
    <div class="relative flex min-h-screen">
      <aside
        class="fixed inset-y-0 left-0 z-50 w-[17.5rem] -translate-x-full border-r border-slate-800/80 bg-slate-950/95 transition-transform duration-200 md:sticky md:top-0 md:h-screen md:translate-x-0"
        id="sidebar-menu"
      >
        <div class="flex h-full flex-col">
          <a
            href="/"
            class="group mx-3 mt-3 flex items-center gap-3 rounded-xl border border-transparent px-3 py-3 transition-colors hover:border-white/10 hover:bg-white/5 focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:outline-none"
          >
            <div
              class="flex h-9 w-9 items-center justify-center rounded-lg bg-linear-to-br from-blue-600 to-violet-600 text-base"
            >
              üõ†Ô∏è
            </div>
            <div class="min-w-0">
              <h1
                class="font-outfit truncate text-base leading-5 font-semibold tracking-tight text-white"
              >
                Tools Hub
              </h1>
              <span class="text-xs text-slate-400">Utilities workspace</span>
            </div>
          </a>

          <div
            class="px-6 pt-4 pb-2 text-[11px] font-semibold tracking-[0.14em] text-slate-500 uppercase"
          >
            Apps & Utilities
          </div>

          <nav
            class="custom-scrollbar flex-1 space-y-1 overflow-y-auto px-3 pb-4"
            aria-label="Tools"
          >
            {
              tools.map((tool) => (
                <a
                  href={tool.path}
                  class:list={[
                    "group flex items-center gap-3 rounded-lg border px-3 py-2 text-sm font-medium transition-colors focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:outline-none",
                    tool.path === Astro.url.pathname
                      ? "border-blue-500/40 bg-blue-500/12 text-blue-200"
                      : "border-transparent text-slate-300 hover:border-slate-700 hover:bg-slate-900 hover:text-white",
                  ]}
                >
                  <span class="text-base leading-none opacity-90">{tool.icon}</span>
                  <span class="truncate">{tool.name}</span>
                  {tool.path === Astro.url.pathname && (
                    <span class="ml-auto h-1.5 w-1.5 rounded-full bg-blue-400" aria-hidden="true" />
                  )}
                </a>
              ))
            }
          </nav>

          <div class="mt-auto border-t border-slate-800/80 p-4">
            <p class="text-xs font-medium text-slate-400">Tools Hub v2.1</p>
            <p class="mt-1 text-xs text-slate-500">Built for fast, focused workflows</p>
          </div>
        </div>
      </aside>

      <main class="min-w-0 flex-1 bg-slate-950">
        <header
          class="sticky top-0 z-40 flex items-center justify-between border-b border-slate-800/80 bg-slate-950/95 px-4 py-3 backdrop-blur md:hidden"
        >
          <a
            href="/"
            class="flex items-center gap-2 focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:outline-none"
          >
            <div
              class="flex h-8 w-8 items-center justify-center rounded-lg bg-linear-to-br from-blue-600 to-violet-600"
            >
              üõ†Ô∏è
            </div>
            <span class="font-semibold tracking-tight text-white">Tools Hub</span>
          </a>
          <button
            id="mobile-menu-toggle"
            class="rounded-lg border border-slate-700 p-2 text-slate-200 transition-colors hover:bg-slate-900 focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:outline-none"
            aria-label="Toggle Menu"
            aria-controls="sidebar-menu"
            aria-expanded="false"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </header>

        <div class="page-shell">
          <slot />
        </div>
      </main>
    </div>

    <div
      id="sidebar-overlay"
      class="pointer-events-none fixed inset-0 z-40 bg-black/60 opacity-0 transition-opacity duration-200 md:hidden"
    >
    </div>
  </body>
</html>

<style is:global>
  * {
    margin: 0;
    padding: 0px;
    box-sizing: border-box;
    font-family: "Inter", system-ui, sans-serif;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: "Outfit", system-ui, sans-serif;
  }

  html {
    scroll-behavior: smooth;
  }

  .page-shell {
    width: 100%;
    max-width: 110rem;
    margin-inline: auto;
    padding: 1rem 1rem 1.5rem;
  }

  @media (min-width: 768px) {
    .page-shell {
      padding: 1.25rem 1.5rem 1.75rem;
    }
  }

  @media (min-width: 1280px) {
    .page-shell {
      padding: 1.5rem 2rem 2rem;
    }
  }

  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background: rgb(30, 41, 59);
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgb(51, 65, 85);
  }
</style>

<script>
  type ClientLogEntry = {
    id: string;
    level: "error";
    source: string;
    message: string;
    stack?: string | null;
    file?: string | null;
    line?: number | null;
    col?: number | null;
    path: string;
    ts: string;
  };

  const LOG_STORAGE_KEY = "toolsHub:clientLogs";
  const MAX_CLIENT_LOGS = 200;
  const LOGGER_FLAG_KEY = "__TOOLS_HUB_LOGGER_INSTALLED__";
  const loggerFlags = window as unknown as Record<string, boolean>;

  function toText(value: unknown): string {
    if (value instanceof Error) {
      return `${value.name}: ${value.message}\n${value.stack || ""}`.trim();
    }

    if (typeof value === "string") return value;

    try {
      return JSON.stringify(value);
    } catch {
      return String(value);
    }
  }

  function appendClientLog(entry: ClientLogEntry) {
    try {
      const existing = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]") as unknown;
      const next = Array.isArray(existing) ? existing : [];
      next.push(entry);

      if (next.length > MAX_CLIENT_LOGS) {
        next.splice(0, next.length - MAX_CLIENT_LOGS);
      }

      localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(next));
      window.dispatchEvent(new CustomEvent("tools-hub:log-added", { detail: entry }));
    } catch {
      // Ignore storage errors (quota/private mode) without breaking app flow.
    }
  }

  if (!loggerFlags[LOGGER_FLAG_KEY]) {
    loggerFlags[LOGGER_FLAG_KEY] = true;

    window.addEventListener("error", (event) => {
      appendClientLog({
        id: crypto.randomUUID(),
        level: "error",
        source: "window.error",
        message: event.message || "Unhandled error",
        stack: event.error?.stack || null,
        file: event.filename || null,
        line: event.lineno || null,
        col: event.colno || null,
        path: location.pathname,
        ts: new Date().toISOString(),
      });
    });

    window.addEventListener("unhandledrejection", (event) => {
      appendClientLog({
        id: crypto.randomUUID(),
        level: "error",
        source: "window.unhandledrejection",
        message: toText(event.reason || "Unhandled promise rejection"),
        stack: event.reason?.stack || null,
        path: location.pathname,
        ts: new Date().toISOString(),
      });
    });

    const originalConsoleError = console.error.bind(console);
    console.error = (...args: unknown[]) => {
      appendClientLog({
        id: crypto.randomUUID(),
        level: "error",
        source: "console.error",
        message: args.map(toText).join(" "),
        path: location.pathname,
        ts: new Date().toISOString(),
      });
      originalConsoleError(...args);
    };
  }

  // Sidebar Toggle Logic
  const toggle = document.getElementById("mobile-menu-toggle") as HTMLButtonElement | null;
  const sidebar = document.getElementById("sidebar-menu");
  const overlay = document.getElementById("sidebar-overlay");

  function closeMenu() {
    sidebar?.classList.add("-translate-x-full");
    overlay?.classList.add("opacity-0", "pointer-events-none");
    toggle?.setAttribute("aria-expanded", "false");
  }

  function openMenu() {
    sidebar?.classList.remove("-translate-x-full");
    overlay?.classList.remove("opacity-0", "pointer-events-none");
    toggle?.setAttribute("aria-expanded", "true");
  }

  if (toggle) {
    toggle.addEventListener("click", () => {
      const isOpen = !sidebar?.classList.contains("-translate-x-full");
      if (isOpen) closeMenu();
      else openMenu();
    });
  }

  overlay?.addEventListener("click", closeMenu);

  document.querySelectorAll("nav a").forEach((link) => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 768) {
        closeMenu();
      }
    });
  });
</script>
