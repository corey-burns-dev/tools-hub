---
import Button from "../components/Button.astro";
import ToolCard from "../components/ui/ToolCard.astro";
import ToolGrid from "../components/ui/ToolGrid.astro";
import ToolPage from "../components/ui/ToolPage.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout title="Habit Tracker">
  <ToolPage>
    <ToolGrid cols={3} class="gap-8">
      <div class="lg:col-span-1">
        <ToolCard title="Create Habit" step="01." bodyClass="space-y-5">
          <div class="space-y-2">
            <label
              for="habit-name"
              class="text-xs font-bold tracking-wider text-slate-500 uppercase">Habit Name</label
            >
            <input
              id="habit-name"
              type="text"
              maxlength="60"
              placeholder="e.g. Drink water"
              class="ui-input"
            />
          </div>

          <div class="space-y-2">
            <label
              for="habit-color"
              class="text-xs font-bold tracking-wider text-slate-500 uppercase">Color Tag</label
            >
            <input
              id="habit-color"
              type="color"
              value="#22c55e"
              class="h-11 w-full cursor-pointer rounded-xl border border-slate-700 bg-slate-900/50 p-1"
            />
          </div>

          <div class="ui-action-row mt-2">
            <Button id="add-habit" variant="primary" class="w-full sm:w-auto sm:min-w-[170px]">
              Add Habit
            </Button>
          </div>
        </ToolCard>
      </div>

      <div class="lg:col-span-2">
        <ToolCard title="Today" step="02." bodyClass="space-y-5">
          <div class="ui-output-box p-5 md:p-6">
            <p id="summary" class="text-sm text-slate-300">0 / 0 habits completed today</p>
            <div class="mt-3 h-2 overflow-hidden rounded-full bg-slate-800">
              <div id="progress-bar" class="h-full w-0 rounded-full bg-emerald-500 transition-all">
              </div>
            </div>
          </div>

          <div id="habit-list" class="space-y-3">
            <div
              class="rounded-xl border border-slate-800 bg-slate-900/40 p-5 text-sm text-slate-500"
            >
              Add your first habit to start tracking.
            </div>
          </div>
        </ToolCard>
      </div>

      <div class="lg:col-span-3">
        <ToolCard title="Stats" step="03." bodyClass="space-y-4">
          <div id="stats-grid" class="grid gap-4 sm:grid-cols-3">
            <div class="rounded-xl border border-slate-800 bg-slate-900/30 p-5">
              <p class="text-xs font-bold tracking-wider text-slate-500 uppercase">Total Habits</p>
              <p id="stat-total" class="mt-2 text-2xl font-bold text-white">0</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-900/30 p-5">
              <p class="text-xs font-bold tracking-wider text-slate-500 uppercase">
                Completed Today
              </p>
              <p id="stat-done" class="mt-2 text-2xl font-bold text-emerald-400">0</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-900/30 p-5">
              <p class="text-xs font-bold tracking-wider text-slate-500 uppercase">
                Best Current Streak
              </p>
              <p id="stat-streak" class="mt-2 text-2xl font-bold text-blue-400">0</p>
            </div>
          </div>
        </ToolCard>
      </div>
    </ToolGrid>
  </ToolPage>
</Layout>

<script>
  type Habit = {
    id: string;
    name: string;
    color: string;
    checkins: Record<string, boolean>;
    createdAt: string;
  };

  const STORAGE_KEY = "toolsHub:habitTracker:v1";

  const nameInput = document.getElementById("habit-name") as HTMLInputElement;
  const colorInput = document.getElementById("habit-color") as HTMLInputElement;
  const addHabitBtn = document.getElementById("add-habit");
  const habitList = document.getElementById("habit-list") as HTMLDivElement;
  const summaryEl = document.getElementById("summary") as HTMLParagraphElement;
  const progressBar = document.getElementById("progress-bar") as HTMLDivElement;
  const statTotal = document.getElementById("stat-total") as HTMLParagraphElement;
  const statDone = document.getElementById("stat-done") as HTMLParagraphElement;
  const statStreak = document.getElementById("stat-streak") as HTMLParagraphElement;

  function getToday() {
    return new Date().toISOString().slice(0, 10);
  }

  function loadHabits(): Habit[] {
    try {
      const parsed = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function saveHabits(habits: Habit[]) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(habits));
  }

  function countStreak(checkins: Record<string, boolean>) {
    const doneDays = new Set(Object.keys(checkins || {}).filter((day) => checkins[day]));
    let streak = 0;
    const cursor = new Date();

    while (true) {
      const day = cursor.toISOString().slice(0, 10);
      if (!doneDays.has(day)) break;
      streak += 1;
      cursor.setDate(cursor.getDate() - 1);
    }

    return streak;
  }

  function render() {
    const habits = loadHabits();
    const today = getToday();

    if (habits.length === 0) {
      habitList.innerHTML = `
        <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-5 text-sm text-slate-500">
          Add your first habit to start tracking.
        </div>
      `;
    } else {
      habitList.innerHTML = habits
        .map((habit) => {
          const checked = Boolean(habit.checkins?.[today]);
          const streak = countStreak(habit.checkins || {});
          return `
            <article class="rounded-xl border border-slate-800 bg-slate-900/30 p-5">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div class="flex items-center gap-3">
                  <span class="inline-block h-3 w-3 rounded-full" style="background:${habit.color || "#22c55e"}"></span>
                  <div>
                    <p class="font-semibold text-white">${habit.name}</p>
                    <p class="text-xs text-slate-400">Current streak: ${streak} day${streak === 1 ? "" : "s"}</p>
                  </div>
                </div>
                <button type="button" class="delete-habit rounded-lg bg-red-500/15 px-3 py-1.5 text-xs font-semibold text-red-300 hover:bg-red-500/25" data-id="${habit.id}">Delete</button>
              </div>

              <label class="mt-4 flex items-center gap-3 text-sm text-slate-300">
                <input type="checkbox" class="toggle-habit h-4 w-4 rounded border-slate-600 bg-slate-800 text-emerald-500" data-id="${habit.id}" ${checked ? "checked" : ""} />
                Mark complete for today
              </label>
            </article>
          `;
        })
        .join("");
    }

    const completed = habits.filter((habit) => Boolean(habit.checkins?.[today])).length;
    const percent = habits.length === 0 ? 0 : Math.round((completed / habits.length) * 100);
    const maxStreak = habits.reduce(
      (best, habit) => Math.max(best, countStreak(habit.checkins || {})),
      0
    );

    summaryEl.textContent = `${completed} / ${habits.length} habits completed today`;
    progressBar.style.width = `${percent}%`;

    statTotal.textContent = String(habits.length);
    statDone.textContent = String(completed);
    statStreak.textContent = String(maxStreak);

    habitList.querySelectorAll(".toggle-habit").forEach((input) => {
      input.addEventListener("change", (event) => {
        const target = event.target as HTMLInputElement;
        const id = target.getAttribute("data-id");
        const next = loadHabits().map((habit) => {
          if (habit.id !== id) return habit;
          const checkins = habit.checkins || {};
          checkins[today] = target.checked;
          return { ...habit, checkins };
        });
        saveHabits(next);
        render();
      });
    });

    habitList.querySelectorAll(".delete-habit").forEach((button) => {
      button.addEventListener("click", (event) => {
        const target = event.target as HTMLElement;
        const id = target.getAttribute("data-id");
        const next = loadHabits().filter((habit) => habit.id !== id);
        saveHabits(next);
        render();
      });
    });
  }

  function addHabit() {
    const name = (nameInput.value || "").trim();
    if (!name) {
      nameInput.focus();
      return;
    }

    const habits = loadHabits();
    habits.unshift({
      id: crypto.randomUUID(),
      name,
      color: colorInput.value || "#22c55e",
      checkins: {},
      createdAt: new Date().toISOString(),
    });

    saveHabits(habits);
    nameInput.value = "";
    render();
    nameInput.focus();
  }

  addHabitBtn?.addEventListener("click", addHabit);
  nameInput?.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      addHabit();
    }
  });

  render();
</script>
