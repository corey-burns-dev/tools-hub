---
import Button from "@/components/ui/Button.astro";
import ToolCard from "@/components/ui/ToolCard.astro";
import ToolPage from "@/components/ui/ToolPage.astro";
import Layout from "../layouts/Layout.astro";

if (!import.meta.env.DEV) {
  return Astro.redirect("/");
}
---

<Layout
  title="Debug Logs"
  description="Internal client-side debug logs for Tools Hub."
  noindex={true}
>
  <ToolPage description="Captured client-side errors and crashes from this browser.">
    <div class="mx-auto w-full max-w-5xl">
      <ToolCard title="Error Console" step="DEV">
        <div slot="header-actions" class="flex flex-wrap gap-2">
          <Button id="refresh-logs" variant="secondary" size="sm" class="h-8 text-[10px]">
            REFRESH
          </Button>
          <Button
            id="download-logs"
            variant="secondary"
            size="sm"
            class="h-8 border-blue-500/20 text-[10px] text-blue-400"
          >
            DOWNLOAD JSON
          </Button>
          <Button id="clear-logs" variant="danger" size="sm" class="h-8 text-[10px]">
            CLEAR
          </Button>
        </div>

        <div
          id="log-stats"
          class="px-1 text-[10px] font-bold tracking-widest text-slate-500 uppercase"
        >
          0 entries
        </div>

        <div id="logs-list" class="mt-6 space-y-4">
          <!-- Logs are rendered by script -->
          <div
            class="rounded-xl border border-dashed border-white/5 bg-white/5 p-8 text-center text-slate-500"
          >
            Scanning for logs...
          </div>
        </div>
      </ToolCard>
    </div>
  </ToolPage>
</Layout>

<script>
  type ClientLogEntry = {
    id?: string;
    level?: string;
    source?: string;
    message?: string;
    stack?: string | null;
    file?: string | null;
    line?: number | null;
    col?: number | null;
    path?: string;
    ts?: string;
  };

  const LOG_STORAGE_KEY = "toolsHub:clientLogs";
  const logsList = document.getElementById("logs-list");
  const stats = document.getElementById("log-stats");
  const refreshBtn = document.getElementById("refresh-logs");
  const clearBtn = document.getElementById("clear-logs");
  const downloadBtn = document.getElementById("download-logs");

  function escapeHtml(value: string): string {
    return value
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function readLogs(): ClientLogEntry[] {
    try {
      const raw = localStorage.getItem(LOG_STORAGE_KEY);
      const parsed = JSON.parse(raw || "[]") as unknown;
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function render() {
    if (!logsList || !stats) return;
    const logs = readLogs().slice().reverse();
    stats.textContent = `${logs.length} entr${logs.length === 1 ? "y" : "ies"}`;

    if (logs.length === 0) {
      logsList.innerHTML = `
        <div class="rounded-xl border border-dashed border-white/10 bg-white/5 p-12 text-center">
          <p class="text-[10px] font-bold tracking-widest text-slate-500 uppercase">Clear Skies</p>
          <p class="text-xs text-slate-400 mt-2">No client errors captured yet.</p>
        </div>
      `;
      return;
    }

    logsList.innerHTML = logs
      .map((log: ClientLogEntry) => {
        const title = escapeHtml(log.message || "Unknown error");
        const source = escapeHtml(log.source || "unknown");
        const time = escapeHtml(log.ts || "");
        const path = escapeHtml(log.path || "");
        const details = escapeHtml(
          JSON.stringify(
            {
              file: log.file || null,
              line: log.line || null,
              col: log.col || null,
              stack: log.stack || null,
            },
            null,
            2
          )
        );

        return `
          <article class="rounded-xl border border-white/5 bg-black/40 p-5 group hover:border-red-500/20 transition-colors">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <p class="text-sm font-bold text-rose-400">${title}</p>
              <p class="text-[10px] font-mono font-medium text-slate-600">${time}</p>
            </div>
            <p class="mt-2 text-[10px] font-bold tracking-wider text-slate-500 uppercase">source: <span class="text-slate-400">${source}</span> | path: <span class="text-slate-400">${path}</span></p>
            <pre class="mt-4 overflow-x-auto rounded-lg bg-black/40 p-4 font-mono text-xs text-slate-400 border border-white/5 group-hover:bg-black/60 transition-colors">${details}</pre>
          </article>
        `;
      })
      .join("");
  }

  refreshBtn?.addEventListener("click", render);
  clearBtn?.addEventListener("click", () => {
    localStorage.removeItem(LOG_STORAGE_KEY);
    render();
  });

  downloadBtn?.addEventListener("click", () => {
    const logs = readLogs();
    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `tools-hub-debug-logs-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
  });

  window.addEventListener("tools-hub:log-added", render);
  window.addEventListener("load", render);
</script>
