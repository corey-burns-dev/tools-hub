---
import Button from "../components/Button.astro";
import ToolCard from "../components/ui/ToolCard.astro";
import ToolGrid from "../components/ui/ToolGrid.astro";
import ToolPage from "../components/ui/ToolPage.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout title="Measurement Converter">
  <ToolPage>
    <ToolGrid cols={2} class="gap-10">
      <ToolCard title="Converter" step="01." class="p-7 md:p-8" bodyClass="space-y-6 md:space-y-7">
        <div class="space-y-2">
          <label
            for="category"
            class="text-left text-xs font-bold tracking-wider text-slate-500 uppercase"
            >Measurement Type</label
          >
          <select id="category" class="ui-select">
            <option value="length">Length</option>
            <option value="weight">Weight</option>
            <option value="volume">Volume</option>
            <option value="temperature">Temperature</option>
            <option value="speed">Speed</option>
            <option value="area">Area</option>
          </select>
        </div>

        <div class="grid gap-4 md:grid-cols-[1fr_auto_1fr] md:items-end">
          <div class="space-y-2 rounded-xl border border-slate-800/60 bg-slate-900/30 p-4">
            <label
              for="value-from"
              class="text-left text-xs font-bold tracking-wider text-slate-500 uppercase"
              >From</label
            >
            <input
              id="value-from"
              type="number"
              step="any"
              value="1"
              class="ui-input text-2xl font-bold"
            />
            <select id="unit-from" class="ui-select"></select>
          </div>

          <div class="flex justify-center">
            <button
              id="swap-btn"
              type="button"
              class="group flex h-12 w-12 items-center justify-center rounded-full border border-slate-700 bg-slate-800 text-xl text-slate-200 transition-all hover:scale-105 hover:border-blue-500/50 hover:bg-slate-700"
              title="Swap units"
            >
              <span class="transition-transform group-hover:rotate-180">⇄</span>
            </button>
          </div>

          <div class="space-y-2 rounded-xl border border-slate-800/60 bg-slate-900/30 p-4">
            <label
              for="value-to"
              class="text-left text-xs font-bold tracking-wider text-slate-500 uppercase">To</label
            >
            <input
              id="value-to"
              type="text"
              readonly
              class="ui-input text-2xl font-bold text-emerald-400"
            />
            <select id="unit-to" class="ui-select"></select>
          </div>
        </div>

        <div class="ui-action-row mt-1">
          <Button id="convert-btn" variant="primary" class="w-full sm:w-auto sm:min-w-[190px]">
            Convert
          </Button>
        </div>
      </ToolCard>

      <ToolCard title="Result" step="02." class="p-7 md:p-8" bodyClass="space-y-6">
        <div class="ui-output-box p-6 md:p-7">
          <p class="text-xs font-bold tracking-wider text-slate-500 uppercase">Converted Value</p>
          <p id="result-value" class="mt-2 text-4xl font-extrabold text-emerald-400">1 m</p>
          <p id="result-meta" class="mt-3 text-sm text-slate-400">Ready to convert</p>
        </div>

        <div class="rounded-xl border border-slate-800/70 bg-slate-900/20 p-5">
          <p class="text-xs font-bold tracking-wider text-slate-500 uppercase">Quick Conversions</p>
          <div id="quick-conversions" class="mt-4 grid gap-3 sm:grid-cols-2"></div>
        </div>
      </ToolCard>
    </ToolGrid>
  </ToolPage>
</Layout>

<script>
  type UnitMeta = { label: string; factor?: number };
  type UnitMap = Record<string, UnitMeta>;
  type Family = { base: string; units: UnitMap };
  type FamilyMap = Record<string, Family>;

  const unitFamilies = {
    length: {
      base: "m",
      units: {
        mm: { label: "Millimeter", factor: 0.001 },
        cm: { label: "Centimeter", factor: 0.01 },
        m: { label: "Meter", factor: 1 },
        km: { label: "Kilometer", factor: 1000 },
        in: { label: "Inch", factor: 0.0254 },
        ft: { label: "Foot", factor: 0.3048 },
        yd: { label: "Yard", factor: 0.9144 },
        mi: { label: "Mile", factor: 1609.344 },
      },
    },
    weight: {
      base: "kg",
      units: {
        mg: { label: "Milligram", factor: 0.000001 },
        g: { label: "Gram", factor: 0.001 },
        kg: { label: "Kilogram", factor: 1 },
        lb: { label: "Pound", factor: 0.45359237 },
        oz: { label: "Ounce", factor: 0.028349523125 },
        t: { label: "Tonne", factor: 1000 },
      },
    },
    volume: {
      base: "l",
      units: {
        ml: { label: "Milliliter", factor: 0.001 },
        l: { label: "Liter", factor: 1 },
        m3: { label: "Cubic Meter", factor: 1000 },
        tsp: { label: "Teaspoon", factor: 0.00492892 },
        tbsp: { label: "Tablespoon", factor: 0.0147868 },
        cup: { label: "Cup", factor: 0.236588 },
        pt: { label: "Pint", factor: 0.473176 },
        gal: { label: "Gallon", factor: 3.78541 },
      },
    },
    speed: {
      base: "mps",
      units: {
        mps: { label: "Meters/sec", factor: 1 },
        kph: { label: "Kilometers/hour", factor: 0.2777777778 },
        mph: { label: "Miles/hour", factor: 0.44704 },
        knot: { label: "Knot", factor: 0.514444 },
      },
    },
    area: {
      base: "m2",
      units: {
        mm2: { label: "mm²", factor: 0.000001 },
        cm2: { label: "cm²", factor: 0.0001 },
        m2: { label: "m²", factor: 1 },
        km2: { label: "km²", factor: 1000000 },
        ft2: { label: "ft²", factor: 0.09290304 },
        yd2: { label: "yd²", factor: 0.83612736 },
        acre: { label: "Acre", factor: 4046.8564224 },
      },
    },
  };

  const temperatureUnits = {
    c: { label: "Celsius" },
    f: { label: "Fahrenheit" },
    k: { label: "Kelvin" },
  };

  const categoryEl = document.getElementById("category") as HTMLSelectElement;
  const valueFromEl = document.getElementById("value-from") as HTMLInputElement;
  const valueToEl = document.getElementById("value-to") as HTMLInputElement;
  const unitFromEl = document.getElementById("unit-from") as HTMLSelectElement;
  const unitToEl = document.getElementById("unit-to") as HTMLSelectElement;
  const resultValueEl = document.getElementById("result-value") as HTMLParagraphElement;
  const resultMetaEl = document.getElementById("result-meta") as HTMLParagraphElement;
  const quickConversionsEl = document.getElementById("quick-conversions") as HTMLDivElement;
  const convertBtn = document.getElementById("convert-btn");
  const swapBtn = document.getElementById("swap-btn");

  function formatNumber(value: number) {
    if (!Number.isFinite(value)) return "0";
    if (Math.abs(value) >= 1000000 || (Math.abs(value) > 0 && Math.abs(value) < 0.0001)) {
      return value.toExponential(4);
    }
    return value.toLocaleString("en-US", { maximumFractionDigits: 6 });
  }

  function toCelsius(value: number, from: string) {
    if (from === "c") return value;
    if (from === "f") return (value - 32) * (5 / 9);
    return value - 273.15;
  }

  function fromCelsius(value: number, to: string) {
    if (to === "c") return value;
    if (to === "f") return value * (9 / 5) + 32;
    return value + 273.15;
  }

  function convertValue(category: string, value: number, fromUnit: string, toUnit: string) {
    if (!Number.isFinite(value)) return 0;

    if (category === "temperature") {
      const celsius = toCelsius(value, fromUnit);
      return fromCelsius(celsius, toUnit);
    }

    const family = (unitFamilies as FamilyMap)[category];
    const fromFactor = family.units[fromUnit].factor;
    const toFactor = family.units[toUnit].factor;
    const baseValue = value * fromFactor;
    return baseValue / toFactor;
  }

  function getUnitMap(category: string): UnitMap {
    if (category === "temperature") return temperatureUnits;
    return (unitFamilies as FamilyMap)[category].units;
  }

  function fillUnitSelect(selectEl: HTMLSelectElement, unitMap: UnitMap, selected: string) {
    selectEl.innerHTML = Object.entries(unitMap)
      .map(
        ([code, meta]) =>
          `<option value="${code}" ${code === selected ? "selected" : ""}>${meta.label} (${code})</option>`
      )
      .join("");
  }

  function renderQuickConversions(category: string, fromUnit: string, toUnit: string) {
    if (!quickConversionsEl) return;

    const presets = [1, 5, 10, 25];
    quickConversionsEl.innerHTML = presets
      .map((n) => {
        const converted = convertValue(category, n, fromUnit, toUnit);
        return `<button type="button" class="quick-convert rounded-lg border border-slate-700 bg-slate-800/50 px-4 py-2.5 text-sm text-slate-200 hover:bg-slate-700" data-value="${n}">${n} ${fromUnit} → ${formatNumber(converted)} ${toUnit}</button>`;
      })
      .join("");

    quickConversionsEl.querySelectorAll(".quick-convert").forEach((btn) => {
      btn.addEventListener("click", () => {
        valueFromEl.value = (btn as HTMLElement).getAttribute("data-value") || "1";
        runConversion();
      });
    });
  }

  function resetUnitsForCategory() {
    const category = categoryEl.value;
    const unitMap = getUnitMap(category);
    const codes = Object.keys(unitMap);

    fillUnitSelect(unitFromEl, unitMap, codes[0]);
    fillUnitSelect(unitToEl, unitMap, codes[Math.min(1, codes.length - 1)]);

    runConversion();
  }

  function runConversion() {
    const category = categoryEl.value;
    const fromUnit = unitFromEl.value;
    const toUnit = unitToEl.value;
    const value = Number.parseFloat(valueFromEl.value || "0");

    const converted = convertValue(category, value, fromUnit, toUnit);
    valueToEl.value = formatNumber(converted);

    resultValueEl.textContent = `${formatNumber(converted)} ${toUnit}`;
    resultMetaEl.textContent = `${formatNumber(value)} ${fromUnit} = ${formatNumber(converted)} ${toUnit}`;

    renderQuickConversions(category, fromUnit, toUnit);
  }

  categoryEl?.addEventListener("change", resetUnitsForCategory);
  valueFromEl?.addEventListener("input", runConversion);
  unitFromEl?.addEventListener("change", runConversion);
  unitToEl?.addEventListener("change", runConversion);
  convertBtn?.addEventListener("click", runConversion);

  swapBtn?.addEventListener("click", () => {
    const from = unitFromEl.value;
    unitFromEl.value = unitToEl.value;
    unitToEl.value = from;
    runConversion();
  });

  resetUnitsForCategory();
</script>
