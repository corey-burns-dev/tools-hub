---
import Button from "@/components/ui/Button.astro";
import ToolCard from "@/components/ui/ToolCard.astro";
import ToolGrid from "@/components/ui/ToolGrid.astro";
import ToolPage from "@/components/ui/ToolPage.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout title="Hash Generator">
  <ToolPage description="Generate SHA hashes from text or files.">
    <ToolGrid cols={2} class="gap-3">
      <div class="space-y-2">
        <ToolCard title="Input" step="01.">
          <textarea id="hash-input" rows="10" placeholder="Paste text here..." class="resize-none"
          ></textarea>

          <div class="mt-4 flex flex-wrap gap-2">
            <Button id="hash-btn" variant="primary">Generate</Button>
            <Button id="clear-btn" variant="ghost"> Clear </Button>
          </div>
        </ToolCard>

        <div class="space-y-3">
          <label class="flex items-center gap-3">
            <input
              id="uppercase-toggle"
              type="checkbox"
              class="h-4 w-4 rounded border-slate-600 bg-slate-800 text-indigo-500 focus:ring-indigo-500"
            />
            Uppercase output
          </label>

          <div
            class="rounded-xl border border-dashed border-white/10 bg-white/5 p-2 text-xs text-slate-400"
          >
            Tip: Drop a file into the output panel to hash it.
          </div>
        </div>
      </div>

      <ToolCard title="Hash Output" step="02." class="flex h-full flex-col">
        <div slot="header-actions">
          <select id="algo-select" class="w-auto px-3 py-1 text-xs">
            <option value="SHA-256">SHA-256</option>
            <option value="SHA-384">SHA-384</option>
            <option value="SHA-512">SHA-512</option>
          </select>
        </div>

        <div class="flex flex-1 flex-col gap-4">
          <textarea
            id="hash-output"
            rows="8"
            placeholder="Hash output will appear here"
            class="mt-0 flex-1 bg-black/50 font-mono text-sm"></textarea>

          <div class="flex items-center justify-between">
            <div
              class="text-[10px] font-bold tracking-widest text-slate-500 uppercase"
              id="hash-meta"
            >
              Ready.
            </div>
            <Button id="copy-btn" variant="ghost" size="sm">Copy</Button>
          </div>

          <div
            id="hash-drop-zone"
            class="flex items-center justify-center rounded-xl border border-dashed border-white/10 bg-white/5 px-4 py-3 text-xs text-slate-400 transition-colors"
          >
            Drop a file here to hash it
          </div>
        </div>
      </ToolCard>
    </ToolGrid>
  </ToolPage>
</Layout>

<script>
  const hashInput = document.querySelector("#hash-input") as HTMLTextAreaElement;
  const hashOutput = document.querySelector("#hash-output") as HTMLTextAreaElement;
  const algoSelect = document.querySelector("#algo-select") as HTMLSelectElement;
  const hashBtn = document.querySelector("#hash-btn") as HTMLButtonElement;
  const clearBtn = document.querySelector("#clear-btn") as HTMLButtonElement;
  const copyBtn = document.querySelector("#copy-btn") as HTMLButtonElement;
  const uppercaseToggle = document.querySelector("#uppercase-toggle") as HTMLInputElement;
  const hashMeta = document.querySelector("#hash-meta") as HTMLDivElement;
  const dropZone = document.querySelector("#hash-drop-zone") as HTMLDivElement;

  const bufferToHex = (buffer: ArrayBuffer) => {
    const hex = Array.from(new Uint8Array(buffer))
      .map((byte) => byte.toString(16).padStart(2, "0"))
      .join("");
    return uppercaseToggle.checked ? hex.toUpperCase() : hex;
  };

  const hashData = async (data: ArrayBuffer) => {
    const algo = algoSelect.value;
    const digest = await crypto.subtle.digest(algo, data);
    return bufferToHex(digest);
  };

  const updateMeta = (label: string) => {
    hashMeta.textContent = label;
  };

  const hashText = async () => {
    if (!hashInput.value) {
      hashOutput.value = "";
      updateMeta("Ready.");
      return;
    }

    const encoder = new TextEncoder();
    const data = encoder.encode(hashInput.value);
    updateMeta("Hashing...");
    hashOutput.value = await hashData(data.buffer);
    updateMeta(`Hashed ${data.length} bytes using ${algoSelect.value}.`);
  };

  const hashFile = async (file: File) => {
    updateMeta(`Hashing ${file.name}...`);
    const buffer = await file.arrayBuffer();
    hashOutput.value = await hashData(buffer);
    updateMeta(`Hashed ${file.name} (${file.size.toLocaleString()} bytes).`);
  };

  hashBtn.addEventListener("click", () => {
    hashText();
  });

  algoSelect.addEventListener("change", () => {
    if (hashInput.value) hashText();
  });

  uppercaseToggle.addEventListener("change", () => {
    if (hashOutput.value) {
      hashOutput.value = uppercaseToggle.checked
        ? hashOutput.value.toUpperCase()
        : hashOutput.value.toLowerCase();
    }
  });

  clearBtn.addEventListener("click", () => {
    hashInput.value = "";
    hashOutput.value = "";
    updateMeta("Ready.");
  });

  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(hashOutput.value);
      copyBtn.textContent = "Copied!";
      setTimeout(() => {
        copyBtn.textContent = "Copy";
      }, 1200);
    } catch {
      copyBtn.textContent = "Copy failed";
      setTimeout(() => {
        copyBtn.textContent = "Copy";
      }, 1200);
    }
  });

  dropZone.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropZone.classList.add("drag-active");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("drag-active");
  });

  dropZone.addEventListener("drop", (event) => {
    event.preventDefault();
    dropZone.classList.remove("drag-active");
    const file = event.dataTransfer?.files[0];
    if (file) hashFile(file);
  });
</script>

<style>
  .drag-active {
    border-color: rgba(99, 102, 241, 0.4);
    background: rgba(99, 102, 241, 0.05);
  }
</style>
