---
import Button from "../components/Button.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout title="Base64 Encoder/Decoder">
  <div class="space-y-12">
    <div class="animate-float mb-12 text-center">
      <div
        class="mb-6 inline-flex h-16 w-16 items-center justify-center rounded-2xl bg-linear-to-br from-blue-500 to-violet-500 text-4xl shadow-lg shadow-blue-500/30"
      >
        64
      </div>
      <h1
        class="mb-4 bg-linear-to-r from-blue-400 via-violet-400 to-fuchsia-400 bg-clip-text text-5xl font-bold text-transparent"
      >
        Base64 Tool
      </h1>
      <p class="text-xl text-slate-400">Encode, decode, and inspect Base64 content.</p>
    </div>

    <div class="grid gap-8 lg:grid-cols-2">
      <div class="card-glass">
        <h2 class="mb-4 text-lg font-bold text-white">
          <span class="text-blue-400">01.</span> Input
        </h2>

        <textarea
          id="plain-input"
          rows="10"
          placeholder="Paste text here..."
          class="w-full resize-none rounded-xl border border-white/10 bg-slate-900/50 px-4 py-3 text-white placeholder-slate-600 transition-all outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
        ></textarea>

        <div class="mt-4 flex flex-wrap gap-2">
          <Button id="encode-btn" variant="primary" class="px-10 sm:w-auto"> Encode → </Button>
          <Button id="decode-btn" variant="secondary" class="px-10 sm:w-auto"> ← Decode </Button>
          <Button id="clear-btn" variant="ghost" class="px-10 sm:w-auto"> Clear </Button>
        </div>

        <div class="mt-6 space-y-3">
          <label class="flex items-center gap-3 text-sm text-slate-300">
            <input
              id="url-safe"
              type="checkbox"
              class="h-4 w-4 rounded border-slate-600 bg-slate-800 text-blue-500 focus:ring-blue-500"
            />
            Use URL-safe Base64 (- and _ instead of + and /)
          </label>

          <div
            class="rounded-xl border border-dashed border-white/10 bg-white/5 p-4 text-xs text-slate-400"
          >
            Tip: Drag a small file into the Base64 output area to encode it.
          </div>
        </div>
      </div>

      <div class="card-glass flex flex-col">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-lg font-bold text-white">
            <span class="text-violet-400">02.</span> Base64 Output
          </h2>
          <Button id="copy-btn" variant="ghost" class="px-4 py-2 text-sm">Copy</Button>
        </div>

        <textarea
          id="base64-output"
          rows="12"
          placeholder="Base64 output will appear here"
          class="w-full flex-1 resize-none rounded-xl border border-white/10 bg-black/50 px-4 py-3 font-mono text-sm text-white outline-none"
        ></textarea>

        <div
          id="drop-zone"
          class="mt-4 flex items-center justify-center rounded-xl border border-dashed border-white/10 bg-white/5 px-4 py-4 text-xs text-slate-400"
        >
          Drop a file here to encode it
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const plainInput = document.querySelector("#plain-input") as HTMLTextAreaElement;
  const base64Output = document.querySelector("#base64-output") as HTMLTextAreaElement;
  const encodeBtn = document.querySelector("#encode-btn") as HTMLButtonElement;
  const decodeBtn = document.querySelector("#decode-btn") as HTMLButtonElement;
  const clearBtn = document.querySelector("#clear-btn") as HTMLButtonElement;
  const copyBtn = document.querySelector("#copy-btn") as HTMLButtonElement;
  const urlSafeToggle = document.querySelector("#url-safe") as HTMLInputElement;
  const dropZone = document.querySelector("#drop-zone") as HTMLDivElement;

  const toBase64 = (value: string) => {
    const bytes = new TextEncoder().encode(value);
    let binary = "";
    bytes.forEach((byte) => {
      binary += String.fromCharCode(byte);
    });
    const encoded = btoa(binary);
    if (!urlSafeToggle.checked) return encoded;
    return encoded.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  };

  const fromBase64 = (value: string) => {
    let cleaned = value.trim();
    if (urlSafeToggle.checked) {
      cleaned = cleaned.replace(/-/g, "+").replace(/_/g, "/");
      const padding = cleaned.length % 4;
      if (padding) cleaned += "=".repeat(4 - padding);
    }
    const binary = atob(cleaned);
    const bytes = Uint8Array.from(binary, (char) => char.charCodeAt(0));
    return new TextDecoder().decode(bytes);
  };

  const encodeText = () => {
    base64Output.value = plainInput.value ? toBase64(plainInput.value) : "";
  };

  const decodeText = () => {
    if (!plainInput.value) {
      base64Output.value = "";
      return;
    }
    try {
      base64Output.value = fromBase64(plainInput.value);
    } catch {
      base64Output.value = "Unable to decode. Check the Base64 input.";
    }
  };

  const handleFile = (file: File) => {
    const reader = new FileReader();
    reader.onload = () => {
      const buffer = new Uint8Array(reader.result as ArrayBuffer);
      let binary = "";
      buffer.forEach((byte) => {
        binary += String.fromCharCode(byte);
      });
      const encoded = btoa(binary);
      base64Output.value = urlSafeToggle.checked
        ? encoded.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "")
        : encoded;
      plainInput.value = file.name;
    };
    reader.readAsArrayBuffer(file);
  };

  encodeBtn.addEventListener("click", encodeText);
  decodeBtn.addEventListener("click", decodeText);
  clearBtn.addEventListener("click", () => {
    plainInput.value = "";
    base64Output.value = "";
  });

  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(base64Output.value);
      copyBtn.textContent = "Copied!";
      setTimeout(() => {
        copyBtn.textContent = "Copy";
      }, 1200);
    } catch {
      copyBtn.textContent = "Copy failed";
      setTimeout(() => {
        copyBtn.textContent = "Copy";
      }, 1200);
    }
  });

  dropZone.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropZone.classList.add("drag-active");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("drag-active");
  });

  dropZone.addEventListener("drop", (event) => {
    event.preventDefault();
    dropZone.classList.remove("drag-active");
    const file = event.dataTransfer?.files[0];
    if (file) handleFile(file);
  });
</script>

<style>
  .drag-active {
    border-color: rgba(59, 130, 246, 0.6);
    background: rgba(59, 130, 246, 0.1);
  }
</style>
