---
import Button from "@/components/ui/Button.astro";
import ToolCard from "@/components/ui/ToolCard.astro";
import ToolGrid from "@/components/ui/ToolGrid.astro";
import ToolPage from "@/components/ui/ToolPage.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout title="URL Encoder/Decoder">
  <ToolPage description="Encode, decode, and inspect query strings.">
    <ToolGrid cols={2} class="gap-8">
      <ToolCard title="Input" step="01.">
        <textarea
          id="url-input"
          rows="10"
          placeholder="Paste a URL or query string..."
          class="resize-none">https://example.com/?q=hello world&color=blue%2Fgreen</textarea
        >

        <div class="mt-4 flex flex-wrap gap-2">
          <Button id="encode-btn" variant="primary"> Encode </Button>
          <Button id="decode-btn" variant="secondary"> Decode </Button>
          <Button id="clear-btn" variant="ghost"> Clear </Button>
        </div>
      </ToolCard>

      <div class="space-y-6">
        <ToolCard title="Output" step="02.">
          <div slot="header-actions">
            <Button id="copy-btn" variant="ghost" size="sm">Copy</Button>
          </div>
          <textarea id="url-output" rows="7" readonly class="mt-0 bg-black/50"></textarea>
        </ToolCard>

        <ToolCard title="Query Params" step="03.">
          <div id="params" class="space-y-2 text-sm text-slate-300">
            <div class="rounded-lg border border-white/10 bg-white/5 p-3 text-slate-500">
              No query parameters found yet.
            </div>
          </div>
        </ToolCard>
      </div>
    </ToolGrid>
  </ToolPage>
</Layout>

<script>
  const inputEl = document.querySelector("#url-input") as HTMLTextAreaElement;
  const outputEl = document.querySelector("#url-output") as HTMLTextAreaElement;
  const paramsEl = document.querySelector("#params") as HTMLDivElement;
  const encodeBtn = document.querySelector("#encode-btn") as HTMLButtonElement;
  const decodeBtn = document.querySelector("#decode-btn") as HTMLButtonElement;
  const clearBtn = document.querySelector("#clear-btn") as HTMLButtonElement;
  const copyBtn = document.querySelector("#copy-btn") as HTMLButtonElement;

  const setParams = (params: Array<[string, string]>) => {
    if (!params.length) {
      paramsEl.innerHTML =
        '<div class="rounded-lg border border-white/10 bg-white/5 p-3 text-slate-500">No query parameters found yet.</div>';
      return;
    }

    paramsEl.innerHTML = params
      .map(
        ([key, value]) =>
          `<div class="flex items-center justify-between rounded-lg border border-white/10 bg-white/5 px-3 py-2">
            <span class="font-mono text-slate-200">${key}</span>
            <span class="text-slate-400">${value}</span>
          </div>`
      )
      .join("");
  };

  const extractQuery = (text: string) => {
    const trimmed = text.trim();
    if (!trimmed) return "";
    try {
      const url = new URL(trimmed, "https://example.com");
      return url.search.startsWith("?") ? url.search.slice(1) : url.search;
    } catch {
      return trimmed.startsWith("?") ? trimmed.slice(1) : trimmed;
    }
  };

  const updateParams = (text: string) => {
    const query = extractQuery(text);
    const search = new URLSearchParams(query);
    setParams([...search.entries()]);
  };

  const encodeValue = () => {
    const value = inputEl.value;
    outputEl.value = encodeURIComponent(value);
    updateParams(outputEl.value);
  };

  const decodeValue = () => {
    const value = inputEl.value;
    try {
      outputEl.value = decodeURIComponent(value);
      updateParams(outputEl.value);
    } catch {
      outputEl.value = "Unable to decode. Check for malformed escape sequences.";
      setParams([]);
    }
  };

  encodeBtn.addEventListener("click", encodeValue);
  decodeBtn.addEventListener("click", decodeValue);
  clearBtn.addEventListener("click", () => {
    inputEl.value = "";
    outputEl.value = "";
    setParams([]);
  });

  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(outputEl.value);
      copyBtn.textContent = "Copied!";
      setTimeout(() => {
        copyBtn.textContent = "Copy";
      }, 1200);
    } catch {
      copyBtn.textContent = "Copy failed";
      setTimeout(() => {
        copyBtn.textContent = "Copy";
      }, 1200);
    }
  });

  outputEl.value = "";
  encodeValue();
</script>
