---
const themes = [
  { id: "neon", name: "Neon Cyber", color: "#00FFA3" },
  { id: "sunset", name: "Sunset Lux", color: "#FF9A8B" },
  { id: "oceanic", name: "Oceanic", color: "#2193B0" },
  { id: "purple", name: "Royale", color: "#8E2DE2" },
  { id: "forest", name: "Forest", color: "#22c55e" },
  { id: "berry", name: "Berry", color: "#db2777" },
  { id: "midnight", name: "Midnight", color: "#6366f1" },
  { id: "solar", name: "Solar", color: "#f59e0b" },
  { id: "arctic", name: "Arctic", color: "#0ea5e9" },
  { id: "minimal", name: "Frosted", color: "#FFFFFF" },
];
---

<div class="relative z-50">
  <button
    id="theme-btn"
    class="glass hover:glass-hover flex min-w-[40px] items-center justify-center gap-2 rounded-xl px-3 py-2 transition-all"
    aria-label="Change theme"
  >
    <span class="text-xl">ðŸŽ¨</span>
  </button>

  <!-- Dropdown -->
  <div
    id="theme-dropdown"
    class="invisible absolute top-full right-0 z-50 mt-2 w-48 origin-top-right scale-95 transform rounded-xl border border-white/10 bg-slate-950 p-2 opacity-0 shadow-2xl transition-all duration-300"
  >
    <div class="space-y-1">
      {
        themes.map((theme) => (
          <button
            class="theme-option flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left text-sm font-medium transition-colors hover:bg-white/10"
            data-theme={theme.id}
          >
            <span
              class="h-4 w-4 rounded-full border border-white/20 shadow-sm"
              style={`background: ${theme.color}`}
            />
            <span class="text-slate-200">{theme.name}</span>
          </button>
        ))
      }
    </div>
  </div>
</div>

<script is:inline>
  // Robust Theme Picker Logic using Event Delegation
  document.addEventListener("click", (e) => {
    const target = e.target;
    const themeBtn = target.closest("#theme-btn");
    const themeDropdown = document.getElementById("theme-dropdown");
    const themeOption = target.closest(".theme-option");

    if (!themeDropdown) return;

    // Toggle Dropdown
    if (themeBtn) {
      e.stopPropagation();
      const isHidden = themeDropdown.classList.contains("invisible");
      if (isHidden) {
        themeDropdown.classList.remove("opacity-0", "invisible", "scale-95");
        themeDropdown.classList.add("opacity-100", "visible", "scale-100");
      } else {
        themeDropdown.classList.add("opacity-0", "invisible", "scale-95");
        themeDropdown.classList.remove("opacity-100", "visible", "scale-100");
      }
      return;
    }

    // Select Theme
    if (themeOption) {
      e.stopPropagation();
      const theme = themeOption.dataset.theme;
      if (theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
      }
      // Close dropdown
      themeDropdown.classList.add("opacity-0", "invisible", "scale-95");
      themeDropdown.classList.remove("opacity-100", "visible", "scale-100");
      return;
    }

    // Close if clicking outside
    if (!themeDropdown.contains(target)) {
      themeDropdown.classList.add("opacity-0", "invisible", "scale-95");
      themeDropdown.classList.remove("opacity-100", "visible", "scale-100");
    }
  });

  // Initial Theme Load
  const savedTheme = localStorage.getItem("theme") || "neon";
  document.documentElement.setAttribute("data-theme", savedTheme);

  // Re-apply on view transitions
  document.addEventListener("astro:after-swap", () => {
    const savedTheme = localStorage.getItem("theme") || "neon";
    document.documentElement.setAttribute("data-theme", savedTheme);
  });
</script>
